<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Road-Based Route Planner</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <style>
    :root {
      color-scheme: light dark;
      --bg: light-dark(#f6f7fb, #0e1116);
      --panel-bg: light-dark(rgba(255,255,255,0.9), rgba(20,24,31,0.9));
      --panel-border: light-dark(rgba(0,0,0,0.1), rgba(255,255,255,0.1));
      --shadow: 0 4px 20px rgba(0,0,0,0.15);
      --text: light-dark(#1b1f23, #e7ecf2);
      --muted: light-dark(#6b7280, #9aa5b1);
      --brand: #1263ff;
      --brand-weak: rgba(18,99,255,0.1);
      --accent: light-dark(#0a84ff, #6aa2ff);
      --danger: #e5484d;
      --success: #20c997;
      --warning: #ffd700;
      --location-blue: #007aff; /* New blue color for location */
      --radius: 8px;
      --btn-bg: light-dark(#ffffff, #171b21);
      --btn-border: light-dark(#e5e7eb, #2b313b);
      --btn-hover: light-dark(#f1f5f9, #222834);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; }
    #map { height: 100%; }

    .glass {
      background: var(--panel-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    /* COMPACT TOP HEADER - Smaller Search Panel */
    #searchPanel {
      position: absolute;
      z-index: 1000;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: 720px;
      max-width: calc(100vw - 24px);
      padding: 12px 16px;
    }

    .search-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .search-title {
      font: 600 14px/1 system-ui, Arial;
      color: var(--text);
      white-space: nowrap;
    }

    .search-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr auto;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .search-group {
      position: relative;
    }

    .search-input {
      padding: 8px 12px;
      border: 1px solid var(--btn-border);
      border-radius: 6px;
      background: var(--btn-bg);
      color: var(--text);
      font: 500 13px/1 system-ui, Arial;
      transition: all .2s ease;
      width: 100%;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(18,99,255,0.1);
    }

    .search-input::placeholder {
      color: var(--muted);
      font-size: 12px;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 180px;
      overflow-y: auto;
      background: var(--btn-bg);
      border: 1px solid var(--btn-border);
      border-radius: 6px;
      z-index: 10;
      display: none;
      box-shadow: var(--shadow);
    }

    .search-result-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--panel-border);
      transition: background .2s ease;
    }

    .search-result-item:hover { background: var(--btn-hover); }
    .search-result-item:last-child { border-bottom: none; }

    .search-result-name {
      font-weight: 600;
      color: var(--text);
      font-size: 13px;
    }

    .search-result-address {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .swap-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--btn-bg);
      border: 1px solid var(--btn-border);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all .2s ease;
    }

    .swap-btn:hover {
      background: var(--btn-hover);
      transform: rotate(180deg);
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .action-buttons .btn {
      padding: 6px 12px;
      font-size: 12px;
      min-height: 32px;
    }

    /* LEFT SIDEBAR - Controls with Toggle Switches */
    #controlPanel {
      position: absolute;
      z-index: 1000;
      top: 100px;
      left: 12px;
      width: 270px;
      padding: 14px;
    }

    .control-section {
      margin-bottom: 18px;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--panel-border);
    }

    .control-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    /* Toggle Switch Styles */
    .toggle-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toggle-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      background: rgba(0,0,0,0.02);
      border-radius: 6px;
      transition: background 0.2s ease;
    }

    .toggle-item:hover {
      background: rgba(0,0,0,0.05);
    }

    .toggle-label {
      font: 600 12px/1 system-ui, Arial;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 22px;
      background: var(--btn-border);
      border-radius: 11px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid var(--btn-border);
    }

    .toggle-switch.active {
      background: var(--success);
      border-color: var(--success);
    }

    .toggle-switch.warning.active {
      background: var(--warning);
      border-color: var(--warning);
    }

    .toggle-switch.brand.active {
      background: var(--brand);
      border-color: var(--brand);
    }

    /* Blue location toggle style */
    .toggle-switch.location.active {
      background: var(--location-blue);
      border-color: var(--location-blue);
    }

    .toggle-slider {
      position: absolute;
      top: 1px;
      left: 1px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .toggle-switch.active .toggle-slider {
      transform: translateX(22px);
    }

    /* Special toggle states - changed to blue */
    .toggle-switch.searching {
      background: var(--location-blue);
      border-color: var(--location-blue);
      animation: pulse 1.5s infinite;
    }

    .toggle-switch.searching .toggle-slider {
      background: white;
      box-shadow: 0 0 8px rgba(0, 122, 255, 0.6);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .control-grid.single {
      display: grid;
      grid-template-columns: 1fr;
    }

    /* RIGHT SIDEBAR - Route Info */
    #infoPanel {
      position: absolute;
      z-index: 1000;
      top: 100px;
      right: 12px;
      width: 310px;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      padding: 14px;
    }

    .route-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin: 10px 0;
      text-align: center;
    }

    .stat-item {
      background: var(--brand-weak);
      padding: 10px 6px;
      border-radius: 6px;
      font-size: 11px;
    }

    .stat-value {
      font-weight: 600;
      font-size: 15px;
      color: var(--brand);
      display: block;
    }

    .coordinates-box {
      background: rgba(0,0,0,0.05);
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font: 500 11px/1.4 ui-monospace, monospace;
      color: var(--muted);
    }

    #directionsPanel {
      max-height: 280px;
      overflow-y: auto;
      background: rgba(0,0,0,0.02);
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 12px;
      line-height: 1.4;
    }

    .direction-step {
      padding: 6px 0;
      border-bottom: 1px solid var(--panel-border);
    }

    .direction-step:last-child { border-bottom: none; }

    /* BOTTOM - Routing Options */
    #routingOptions {
      position: absolute;
      z-index: 1000;
      bottom: 12px;
      left: 12px;
      width: 270px;
      padding: 14px;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-bottom: 10px;
    }

    .options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .status-info {
      margin-top: 10px;
      padding: 6px 10px;
      background: rgba(0,0,0,0.05);
      border-radius: 4px;
      font: 500 10px/1.3 ui-monospace, monospace;
      color: var(--muted);
    }

    /* Typography */
    h1, h2, h3 {
      margin: 0 0 10px;
      font-weight: 600;
      color: var(--text);
    }
    h1 { font-size: 16px; }
    h2 { font-size: 14px; }
    h3 { font-size: 13px; }

    .subtitle {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 14px;
      line-height: 1.4;
    }

    /* Buttons */
    .btn {
      appearance: none;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font: 600 12px/1 system-ui, Arial;
      transition: all .2s ease;
      text-align: center;
      min-height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn:hover {
      background: var(--btn-hover);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .btn:active { transform: translateY(0); }
    .btn.brand { border-color: var(--brand); color: #fff; background: var(--brand); }
    .btn.success { border-color: var(--success); color: #fff; background: var(--success); }
    .btn.warning { border-color: var(--warning); color: #000; background: var(--warning); }
    .btn.danger { border-color: var(--danger); color: #fff; background: var(--danger); }
    .btn.ghost { border-color: var(--panel-border); background: transparent; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .btn-sm {
      padding: 6px 10px;
      font-size: 11px;
      min-height: 30px;
    }

    /* Hide default routing machine controls */
    .leaflet-routing-container { display: none; }

    /* Animations */
    .locked-marker {
      animation: lockedPulse 3s ease-in-out infinite;
    }

    @keyframes lockedPulse {
      0%, 100% { box-shadow: 0 0 8px rgba(32, 201, 151, 0.6); }
      50% { box-shadow: 0 0 16px rgba(32, 201, 151, 0.9); }
    }

    /* Updated blue location marker animation */
    .searching-marker {
      animation: searchPulse 1.5s ease-in-out infinite;
    }

    @keyframes searchPulse {
      0%, 100% { box-shadow: 0 0 5px rgba(0, 122, 255, 0.6); }
      50% { box-shadow: 0 0 12px rgba(0, 122, 255, 0.9); }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #searchPanel {
        width: calc(100vw - 16px);
        left: 8px;
        transform: none;
      }
      
      .search-grid {
        grid-template-columns: 1fr auto 1fr;
        gap: 6px;
      }
      
      .search-grid .swap-btn:last-child {
        display: none;
      }
      
      #controlPanel, #routingOptions {
        width: 250px;
      }
      
      #infoPanel {
        width: 290px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- COMPACT TOP: Search Panel -->
  <div id="searchPanel" class="glass">
    <div class="search-header">
      <span class="search-title">🔍 Route Planner</span>
    </div>
    <div class="search-grid">
      <div class="search-group">
        <input type="text" id="fromInput" class="search-input" placeholder="Start location...">
        <div id="fromResults" class="search-results"></div>
      </div>
      <div class="swap-btn" onclick="swapSearchLocations()" title="Swap locations">🔄</div>
      <div class="search-group">
        <input type="text" id="toInput" class="search-input" placeholder="Destination...">
        <div id="toResults" class="search-results"></div>
      </div>
      <button id="routeBtn" class="btn brand">Go</button>
    </div>
    <div class="action-buttons">
      <button id="clearSearch" class="btn ghost">Clear</button>
      <button id="shareLocation" class="btn warning">Share</button>
    </div>
  </div>

  <!-- LEFT: Control Panel with Toggle Switches -->
  <div id="controlPanel" class="glass">
    <h3>⚙️ Controls</h3>
    
    <div class="control-section">
      <div class="toggle-container">
        <!-- Find Me Toggle - changed to blue -->
        <div class="toggle-item">
          <div class="toggle-label">
            📍 Find Location
          </div>
          <div class="toggle-switch location" id="findLocationToggle" onclick="toggleFindLocation()">
            <div class="toggle-slider"></div>
          </div>
        </div>

        <!-- Lock Toggle -->
        <div class="toggle-item">
          <div class="toggle-label">
            🔒 Lock Position
          </div>
          <div class="toggle-switch brand" id="lockToggle" onclick="toggleLockLocation()">
            <div class="toggle-slider"></div>
          </div>
        </div>

        <!-- Follow Toggle -->
        <div class="toggle-item">
          <div class="toggle-label">
            👤 Follow Mode
          </div>
          <div class="toggle-switch" id="followToggle" onclick="toggleFollowMode()">
            <div class="toggle-slider"></div>
          </div>
        </div>

        <!-- Traffic Heat Toggle -->
        <div class="toggle-item">
          <div class="toggle-label">
            🌡️ Traffic Heat
          </div>
          <div class="toggle-switch warning" id="heatToggle" onclick="toggleHeatLayer()">
            <div class="toggle-slider"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="control-section">
      <div class="control-grid single">
        <button id="resetPins" class="btn danger btn-sm">🔄 Reset Route</button>
      </div>
    </div>
  </div>

  <!-- RIGHT: Information Panel -->
  <div id="infoPanel" class="glass">
    <h3>📊 Route Info</h3>
    <div id="routeSummary" class="subtitle">Search locations or click map to plan route</div>
    
    <div class="route-stats">
      <div class="stat-item">
        <span class="stat-value" id="totalDistance">-</span>
        Distance
      </div>
      <div class="stat-item">
        <span class="stat-value" id="totalTime">-</span>
        Duration
      </div>
      <div class="stat-item">
        <span class="stat-value" id="currentMode">Car</span>
        Mode
      </div>
    </div>

    <div class="coordinates-box">
      <div><strong>Start:</strong> <span id="startCoords">Not set</span></div>
      <div><strong>End:</strong> <span id="endCoords">Not set</span></div>
      <div><strong>Service:</strong> <span id="routeService">OpenRouteService</span></div>
    </div>

    <h3>📋 Directions</h3>
    <div id="directionsPanel">Plan a route to see navigation instructions</div>
  </div>

  <!-- BOTTOM: Routing Options -->
  <div id="routingOptions" class="glass">
    <h3>🚗 Travel Modes</h3>
    
    <div class="profile-grid">
      <button id="profileCar" class="btn success btn-sm">🚗</button>
      <button id="profileBike" class="btn ghost btn-sm">🚲</button>
      <button id="profileWalk" class="btn ghost btn-sm">🚶</button>
      <button id="profileTruck" class="btn ghost btn-sm">🚛</button>
    </div>
    
    <div class="options-grid">
      <button id="avoidTolls" class="btn ghost btn-sm">🚫 Tolls</button>
      <button id="avoidHighways" class="btn ghost btn-sm">🚫 Highways</button>
    </div>

    <div class="status-info">
      <div>Profile: <span id="activeProfile">driving-car</span></div>
      <div>Status: <span id="routingStatus">Ready</span></div>
    </div>
  </div>

  <script>
    const TILE_URL = 'https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png';
    const TILE_ATTR = '© OpenStreetMap contributors, OSM France';

    // Initialize map
    const map = L.map('map', { 
      doubleClickZoom: false,
      zoomControl: true 
    }).setView([20.5937, 78.9629], 5);
    
    L.tileLayer(TILE_URL, { 
      maxZoom: 19, 
      attribution: TILE_ATTR 
    }).addTo(map);

    // Variables
    let routingControl = null;
    let startMarker = null, endMarker = null;
    let heatLayer = null, userMarker = null, userAccuracy = null;
    let followUser = false, isLocationLocked = false, isSearchingLocation = false;
    let watchId = null, searchTimeout = null;
    let selectedFromLocation = null, selectedToLocation = null;
    let isHeatLayerActive = false;
    let isLocationActive = false;

    // Configuration
    let currentProfile = 'driving-car';
    let routingOptions = { avoidTolls: false, avoidHighways: false, fastest: true };
    const ORS_API_KEY = '5b3ce3597851110001cf624876c9326c7c3346ff9c65ee2c3c5ba20f';
    const NOMINATIM_URL = 'https://nominatim.openstreetmap.org/search';

    // Event Listeners
    document.getElementById('fromInput').addEventListener('input', (e) => searchLocation(e.target.value, 'from'));
    document.getElementById('toInput').addEventListener('input', (e) => searchLocation(e.target.value, 'to'));
    document.getElementById('routeBtn').addEventListener('click', calculateRouteFromSearch);
    document.getElementById('clearSearch').addEventListener('click', clearSearchInputs);
    document.getElementById('shareLocation').addEventListener('click', shareCurrentRoute);
    
    document.getElementById('resetPins').addEventListener('click', resetRoute);

    document.getElementById('profileCar').addEventListener('click', () => setRoutingProfile('driving-car', 'Car'));
    document.getElementById('profileBike').addEventListener('click', () => setRoutingProfile('cycling-regular', 'Bike'));
    document.getElementById('profileWalk').addEventListener('click', () => setRoutingProfile('foot-walking', 'Walk'));
    document.getElementById('profileTruck').addEventListener('click', () => setRoutingProfile('driving-hgv', 'Truck'));

    document.getElementById('avoidTolls').addEventListener('click', toggleAvoidTolls);
    document.getElementById('avoidHighways').addEventListener('click', toggleAvoidHighways);

    // Map Events
    map.on('click', (e) => {
      if (isLocationLocked && followUser) return;
      
      if (!startMarker) {
        createStartMarker(e.latlng);
      } else if (!endMarker) {
        createEndMarker(e.latlng);
        calculateRoute();
      } else {
        if (confirm('Route exists. Reset and place new start marker?')) {
          resetRoute();
          createStartMarker(e.latlng);
        }
      }
    });

    // Enhanced Toggle Functions
    function toggleFindLocation() {
      const toggle = document.getElementById('findLocationToggle');
      
      if (isLocationActive) {
        // Turn OFF location tracking
        stopLocationTracking();
        toggle.classList.remove('active', 'searching');
        isLocationActive = false;
        
        // Remove location markers
        if (userMarker) {
          map.removeLayer(userMarker);
          userMarker = null;
        }
        if (userAccuracy) {
          map.removeLayer(userAccuracy);
          userAccuracy = null;
        }
      } else {
        // Turn ON location tracking
        startLocationSearch();
        isLocationActive = true;
      }
    }

    function stopLocationTracking() {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      isSearchingLocation = false;
      updateRoutingStatus('Location tracking stopped');
    }

    function toggleLockLocation() {
      const toggle = document.getElementById('lockToggle');
      
      if (!userMarker) {
        alert('Please find your location first before locking it.');
        return;
      }

      if (!isLocationLocked) {
        lockCurrentLocation();
        toggle.classList.add('active');
      } else {
        unlockLocation();
        toggle.classList.remove('active');
      }
    }

    function toggleFollowMode() {
      const toggle = document.getElementById('followToggle');
      followUser = !followUser;
      
      if (followUser) {
        toggle.classList.add('active');
      } else {
        toggle.classList.remove('active');
      }
    }

    function toggleHeatLayer() {
      const toggle = document.getElementById('heatToggle');
      
      if (heatLayer) {
        map.removeLayer(heatLayer);
        heatLayer = null;
        isHeatLayerActive = false;
        toggle.classList.remove('active');
      } else {
        const trafficPoints = [
          [28.6139, 77.2090, 0.9], [19.0760, 72.8777, 0.85],
          [12.9716, 77.5946, 0.8], [22.5726, 88.3639, 0.75],
          [13.0827, 80.2707, 0.7], [17.3850, 78.4867, 0.65],
          [18.5204, 73.8567, 0.6], [23.0225, 72.5714, 0.55]
        ];
        heatLayer = L.heatLayer(trafficPoints, {
          radius: 30, blur: 20, maxZoom: 12,
          gradient: {0.2: 'blue', 0.5: 'yellow', 0.8: 'orange', 1.0: 'red'}
        }).addTo(map);
        isHeatLayerActive = true;
        toggle.classList.add('active');
      }
    }

    function unlockLocation() {
      isLocationLocked = false;
      if (userMarker) {
        userMarker.setStyle({
          fillColor: '#007aff', // Changed to blue
          className: 'searching-marker'
        });
      }
    }

    // Search Functions
    async function searchLocation(query, type) {
      if (!query || query.length < 3) {
        hideSearchResults(type);
        return;
      }

      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(async () => {
        try {
          updateRoutingStatus(`Searching ${query}...`);
          const response = await fetch(`${NOMINATIM_URL}?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=in&addressdetails=1`);
          const results = await response.json();
          displaySearchResults(results, type);
          updateRoutingStatus('Ready');
        } catch (error) {
          console.error('Search error:', error);
          updateRoutingStatus('Search failed');
        }
      }, 300);
    }

    function displaySearchResults(results, type) {
      const resultsContainer = document.getElementById(`${type}Results`);
      
      if (!results || results.length === 0) {
        resultsContainer.innerHTML = '<div class="search-result-item">No locations found</div>';
        resultsContainer.style.display = 'block';
        return;
      }

      const resultsHTML = results.map((result, index) => {
        const displayName = result.display_name.split(',').slice(0, 2).join(',');
        return `
          <div class="search-result-item" onclick="selectSearchResult(${index}, '${type}')">
            <div class="search-result-name">${displayName}</div>
            <div class="search-result-address">${result.display_name}</div>
          </div>
        `;
      }).join('');

      resultsContainer.innerHTML = resultsHTML;
      resultsContainer.style.display = 'block';
      
      if (type === 'from') window.fromSearchResults = results;
      else window.toSearchResults = results;
    }

    function selectSearchResult(index, type) {
      const results = type === 'from' ? window.fromSearchResults : window.toSearchResults;
      const selected = results[index];
      
      const location = {
        lat: parseFloat(selected.lat),
        lon: parseFloat(selected.lon),
        name: selected.display_name.split(',')[0]
      };

      if (type === 'from') {
        selectedFromLocation = location;
        document.getElementById('fromInput').value = location.name;
      } else {
        selectedToLocation = location;
        document.getElementById('toInput').value = location.name;
      }
      
      hideSearchResults(type);
    }

    function hideSearchResults(type) {
      document.getElementById(`${type}Results`).style.display = 'none';
    }

    function calculateRouteFromSearch() {
      if (selectedFromLocation && selectedToLocation) {
        const fromLatLng = L.latLng(selectedFromLocation.lat, selectedFromLocation.lon);
        const toLatLng = L.latLng(selectedToLocation.lat, selectedToLocation.lon);
        
        if (startMarker) map.removeLayer(startMarker);
        if (endMarker) map.removeLayer(endMarker);
        
        createStartMarker(fromLatLng);
        createEndMarker(toLatLng);
        
        const group = new L.featureGroup([startMarker, endMarker]);
        map.fitBounds(group.getBounds().pad(0.1));
        
        setTimeout(() => calculateRoute(), 500);
      } else {
        alert('Please search and select both locations.');
      }
    }

    function swapSearchLocations() {
      const fromInput = document.getElementById('fromInput');
      const toInput = document.getElementById('toInput');
      
      [fromInput.value, toInput.value] = [toInput.value, fromInput.value];
      [selectedFromLocation, selectedToLocation] = [selectedToLocation, selectedFromLocation];
    }

    function clearSearchInputs() {
      document.getElementById('fromInput').value = '';
      document.getElementById('toInput').value = '';
      selectedFromLocation = null;
      selectedToLocation = null;
      hideSearchResults('from');
      hideSearchResults('to');
    }

    // Enhanced Location Functions - Updated to use blue colors
    function startLocationSearch() {
      if (!('geolocation' in navigator)) {
        alert('Geolocation is not supported by this browser.');
        isLocationActive = false;
        document.getElementById('findLocationToggle').classList.remove('active');
        return;
      }

      isSearchingLocation = true;
      const toggle = document.getElementById('findLocationToggle');
      toggle.classList.add('searching');
      updateRoutingStatus('Finding your location...');
      
      // Use watchPosition for continuous tracking
      watchId = navigator.geolocation.watchPosition(
        (position) => {
          const { latitude: lat, longitude: lng, accuracy } = position.coords;
          const latlng = L.latLng(lat, lng);

          // Remove old markers
          if (userMarker) map.removeLayer(userMarker);
          if (userAccuracy) map.removeLayer(userAccuracy);

          // Create new location marker - Changed to blue
          userMarker = L.circleMarker(latlng, {
            radius: 8, 
            fillColor: '#007aff', // Changed from #ffd700 to blue
            color: '#fff', 
            weight: 2,
            opacity: 1, 
            fillOpacity: 0.9, 
            className: 'searching-marker'
          }).addTo(map).bindPopup('📍 Your Location');

          // Create accuracy circle - Changed to blue
          userAccuracy = L.circle(latlng, {
            radius: accuracy, 
            color: '#007aff', // Changed from #ffd700 to blue
            weight: 1,
            fillOpacity: 0.1, 
            dashArray: '3, 3'
          }).addTo(map);

          // Center map on first location fix
          if (isSearchingLocation) {
            map.setView(latlng, 15, { animate: true });
            isSearchingLocation = false;
            toggle.classList.remove('searching');
            toggle.classList.add('active');
            updateRoutingStatus('Location found');

            if (followUser && !startMarker) createStartMarker(latlng);
          }
        },
        (error) => {
          console.error('Location error:', error);
          alert('Unable to get location. Please try again.');
          stopLocationTracking();
          toggle.classList.remove('searching', 'active');
          isLocationActive = false;
          updateRoutingStatus('Location failed');
        },
        { 
          enableHighAccuracy: true, 
          timeout: 15000, 
          maximumAge: 10000 
        }
      );
    }

    // Marker Functions
    function createStartMarker(latlng) {
      startMarker = L.marker(latlng, {
        draggable: true,
        title: 'Start Location'
      }).addTo(map).bindPopup('🟢 Start Location');

      startMarker.on('dragend', () => {
        updateCoordinateDisplay();
        if (endMarker) calculateRoute();
      });

      updateCoordinateDisplay();
    }

    function createEndMarker(latlng) {
      endMarker = L.marker(latlng, {
        draggable: true,
        title: 'End Location'
      }).addTo(map).bindPopup('🔴 End Location');

      endMarker.on('dragend', () => {
        updateCoordinateDisplay();
        if (startMarker) calculateRoute();
      });

      updateCoordinateDisplay();
    }

    // Route Calculation
    function calculateRoute() {
      if (!startMarker || !endMarker) return;

      updateRoutingStatus('Calculating...');

      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }

      try {
        routingControl = L.Routing.control({
          waypoints: [startMarker.getLatLng(), endMarker.getLatLng()],
          router: L.Routing.osrmv1({
            serviceUrl: `https://api.openrouteservice.org/v2/directions/${currentProfile}`,
            profile: currentProfile,
            requestParameters: {
              api_key: ORS_API_KEY,
              options: buildRoutingOptions()
            }
          }),
          routeWhileDragging: false,
          addWaypoints: false,
          createMarker: () => null,
          lineOptions: {
            styles: [{
              color: currentProfile.includes('driving') ? '#1263ff' : 
                     currentProfile.includes('cycling') ? '#20c997' : '#ff6b6b',
              weight: 5,
              opacity: 0.8
            }]
          }
        }).on('routesfound', function(e) {
          updateRouteDisplay(e.routes[0]);
          updateRoutingStatus('Complete');
        }).on('routingerror', function(e) {
          console.error('Routing error:', e);
          fallbackToOSRM();
        }).addTo(map);

      } catch (error) {
        console.error('Routing error:', error);
        fallbackToOSRM();
      }
    }

    function fallbackToOSRM() {
      if (!startMarker || !endMarker) return;

      updateRoutingStatus('Using backup routing...');

      if (routingControl) map.removeControl(routingControl);

      routingControl = L.Routing.control({
        waypoints: [startMarker.getLatLng(), endMarker.getLatLng()],
        router: L.Routing.osrmv1({
          serviceUrl: 'https://router.project-osrm.org/route/v1',
          profile: 'driving'
        }),
        routeWhileDragging: false,
        addWaypoints: false,
        createMarker: () => null,
        lineOptions: { styles: [{ color: '#1263ff', weight: 5, opacity: 0.8 }] }
      }).on('routesfound', function(e) {
        updateRouteDisplay(e.routes[0]);
        updateRoutingStatus('Complete (OSRM)');
      }).on('routingerror', function(e) {
        updateRoutingStatus('Route failed');
        document.getElementById('routeSummary').textContent = 'Unable to calculate route. Try different locations.';
      }).addTo(map);
    }

    function buildRoutingOptions() {
      const options = {};
      if (routingOptions.avoidTolls) {
        options.avoid_features = options.avoid_features || [];
        options.avoid_features.push('tollways');
      }
      if (routingOptions.avoidHighways) {
        options.avoid_features = options.avoid_features || [];
        options.avoid_features.push('highways');
      }
      options.preference = routingOptions.fastest ? 'fastest' : 'shortest';
      return options;
    }

    function updateRouteDisplay(route) {
      const distance = (route.summary.totalDistance / 1000).toFixed(1);
      const time = Math.round(route.summary.totalTime / 60);
      
      document.getElementById('totalDistance').textContent = `${distance} km`;
      document.getElementById('totalTime').textContent = `${time} min`;
      document.getElementById('routeSummary').textContent = 
        `${distance} km journey in ${time} minutes`;

      const directionsHTML = route.instructions.map((instruction, index) => {
        const dist = (instruction.distance / 1000).toFixed(1);
        const dir = instruction.text || instruction.narrative || 'Continue';
        return `<div class="direction-step"><strong>${index + 1}.</strong> ${dir} <small style="color: var(--muted);">(${dist} km)</small></div>`;
      }).join('');

      document.getElementById('directionsPanel').innerHTML = directionsHTML || 
        'Turn-by-turn directions not available for this route.';
    }

    function lockCurrentLocation() {
      if (!userMarker) return;

      isLocationLocked = true;
      const position = userMarker.getLatLng();

      // Keep blue color for locked location too
      userMarker.setStyle({ fillColor: '#20c997', className: 'locked-marker' });

      if (!startMarker) {
        createStartMarker(position);
      } else {
        startMarker.setLatLng(position);
        updateCoordinateDisplay();
        if (endMarker) calculateRoute();
      }
    }

    // Utility Functions
    function setRoutingProfile(profile, name) {
      currentProfile = profile;
      document.getElementById('currentMode').textContent = name;
      document.getElementById('activeProfile').textContent = profile;

      document.querySelectorAll('.profile-grid .btn').forEach(btn => btn.className = 'btn ghost btn-sm');
      
      const activeButton = {
        'driving-car': 'profileCar',
        'cycling-regular': 'profileBike', 
        'foot-walking': 'profileWalk',
        'driving-hgv': 'profileTruck'
      }[profile];

      if (activeButton) {
        document.getElementById(activeButton).className = 'btn success btn-sm';
      }

      if (startMarker && endMarker) calculateRoute();
    }

    function toggleAvoidTolls() {
      routingOptions.avoidTolls = !routingOptions.avoidTolls;
      const btn = document.getElementById('avoidTolls');
      btn.className = routingOptions.avoidTolls ? 'btn warning btn-sm' : 'btn ghost btn-sm';
      if (startMarker && endMarker) calculateRoute();
    }

    function toggleAvoidHighways() {
      routingOptions.avoidHighways = !routingOptions.avoidHighways;
      const btn = document.getElementById('avoidHighways');
      btn.className = routingOptions.avoidHighways ? 'btn warning btn-sm' : 'btn ghost btn-sm';
      if (startMarker && endMarker) calculateRoute();
    }

    function resetRoute() {
      if (startMarker && !isLocationLocked) {
        map.removeLayer(startMarker);
        startMarker = null;
      }
      if (endMarker) {
        map.removeLayer(endMarker);
        endMarker = null;
      }
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
      
      document.getElementById('routeSummary').textContent = 'Search locations or click map to plan route';
      document.getElementById('totalDistance').textContent = '-';
      document.getElementById('totalTime').textContent = '-';
      document.getElementById('directionsPanel').textContent = 'Plan a route to see navigation instructions';
      document.getElementById('startCoords').textContent = 'Not set';
      document.getElementById('endCoords').textContent = 'Not set';
      updateRoutingStatus('Ready');
    }

    function shareCurrentRoute() {
      if (!startMarker || !endMarker) {
        alert('No route to share. Plan a route first.');
        return;
      }

      const start = startMarker.getLatLng();
      const end = endMarker.getLatLng();
      
      const shareData = {
        title: 'My Route Plan',
        text: `Route from ${start.lat.toFixed(4)}, ${start.lng.toFixed(4)} to ${end.lat.toFixed(4)}, ${end.lng.toFixed(4)}`,
        url: `https://www.google.com/maps/dir/${start.lat},${start.lng}/${end.lat},${end.lng}`
      };

      if (navigator.share) {
        navigator.share(shareData).catch(console.error);
      } else {
        navigator.clipboard.writeText(shareData.url).then(() => {
          alert('Route URL copied to clipboard!');
        }).catch(() => {
          alert(`${shareData.text}\n\nGoogle Maps: ${shareData.url}`);
        });
      }
    }

    function updateCoordinateDisplay() {
      if (startMarker) {
        const start = startMarker.getLatLng();
        document.getElementById('startCoords').textContent = 
          `${start.lat.toFixed(4)}, ${start.lng.toFixed(4)}`;
      }
      
      if (endMarker) {
        const end = endMarker.getLatLng();
        document.getElementById('endCoords').textContent = 
          `${end.lat.toFixed(4)}, ${end.lng.toFixed(4)}`;
      }
    }

    function updateRoutingStatus(status) {
      document.getElementById('routingStatus').textContent = status;
    }

    // Hide search results when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#searchPanel')) {
        hideSearchResults('from');
        hideSearchResults('to');
      }
    });

    // Global function for onclick handlers
    window.selectSearchResult = selectSearchResult;

    // Initialize
    updateRoutingStatus('Ready');
  </script>
</body>
</html>
